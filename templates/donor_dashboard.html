{% extends "base.html" %}

{% block title %}My Dashboard{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">My Food Posts</h1>

    <div id="message-area" class="text-center mb-4"></div>

    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <table class="min-w-full leading-normal">
            <thead>
                <tr>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Food Name
                    </th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Posted On
                    </th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Status
                    </th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody id="my-posts-tbody">
            </tbody>
        </table>
    </div>
</div>

<script>
    const tableBody = document.getElementById('my-posts-tbody');
    const messageArea = document.getElementById('message-area');
    const token = localStorage.getItem('access_token');

    if (!token) {
        window.location.href = '/login';
    }

    async function fetchMyPosts() {
        try {
            const response = await fetch('/api/posts/my-posts', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) { // Unauthorized
                    window.location.href = '/login';
                }
                throw new Error('Failed to fetch your posts.');
            }
            
            const myPosts = await response.json();
            tableBody.innerHTML = ''; // Clear existing rows

            if (myPosts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-600">You have not created any posts yet.</td></tr>';
                return;
            }

            const dateOptions = {
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            };

            myPosts.forEach(post => {
                const postDate = new Date(post.post_time).toLocaleString('en-IN', dateOptions);
                const statusClass = post.status === 'Claimed' ? 'text-green-600' : 'text-blue-600';

                const row = `
                    <tr>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${post.food_name}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${postDate}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="font-semibold ${statusClass} whitespace-no-wrap">${post.status}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <button onclick="deletePost(${post.id})" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-600">${error.message}</td></tr>`;
        }
    }

    // Function to handle deleting a post
    async function deletePost(postId) {
        if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/posts/${postId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const result = await response.json();
            messageArea.className = 'text-center p-2 rounded-md mb-4';

            if (response.ok) {
                messageArea.textContent = result.message;
                messageArea.classList.add('bg-green-100', 'text-green-700');
                fetchMyPosts(); 
            } else {
                messageArea.textContent = result.error || 'Failed to delete post.';
                messageArea.classList.add('bg-red-100', 'text-red-700');
            }
        } catch (error) {
            messageArea.textContent = 'Could not connect to the server.';
            messageArea.classList.add('bg-red-100', 'text-red-700');
        }

        setTimeout(() => { messageArea.innerHTML = ''; }, 4000);
    }

    // Fetch posts when the page loads
    document.addEventListener('DOMContentLoaded', fetchMyPosts);
</script>
{% endblock %}
