{% extends "base.html" %}

{% block title %}My Claim History{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">My Claimed Food</h1>

    <!-- Table to display the user's claimed posts -->
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <table class="min-w-full leading-normal">
            <thead>
                <tr>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Food Name
                    </th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Location
                    </th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        Claimed On
                    </th>
                </tr>
            </thead>
            <tbody id="my-claims-tbody">
                <!-- Rows will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<script>
    const tableBody = document.getElementById('my-claims-tbody');
    const token = localStorage.getItem('access_token');

    // Protect the page: redirect if not logged in
    if (!token) {
        window.location.href = '/login';
    }

    // Function to fetch and display the user's claimed posts
    async function fetchMyClaims() {
        try {
            const response = await fetch('/api/claims/my-claims', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                if (response.status === 401) { // Unauthorized
                    window.location.href = '/login';
                }
                throw new Error('Failed to fetch your claims.');
            }
            
            const myClaims = await response.json();
            tableBody.innerHTML = ''; // Clear existing rows

            if (myClaims.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-600">You have not claimed any posts yet.</td></tr>';
                return;
            }

            const dateOptions = {
                timeZone: 'Asia/Kolkata',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            };

            myClaims.forEach(claim => {
                const claimDate = new Date(claim.claim_time).toLocaleString('en-IN', dateOptions);

                const row = `
                    <tr>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${claim.food_name}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${claim.location}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                            <p class="text-gray-900 whitespace-no-wrap">${claimDate}</p>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-600">${error.message}</td></tr>`;
        }
    }

    // Fetch claims when the page loads
    document.addEventListener('DOMContentLoaded', fetchMyClaims);
</script>
{% endblock %}
